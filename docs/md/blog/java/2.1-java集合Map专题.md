## javaé›†åˆMapä¸“é¢˜

ä½œè€…ï¼šqinguan
<br/>åšå®¢ï¼š[https://bugstack.cn](https://bugstack.cn)

> æ•…ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œï¼›ä¸ç§¯å°æµï¼Œæ— ä»¥æˆæ±Ÿæµ·ï¼ğŸŒ»

## ä¸€ã€æ¦‚è¿°
Mapæ˜¯ä¸€ç§é”®-å€¼å¯¹ï¼ˆkey-valueï¼‰é›†åˆï¼ŒMapé›†åˆä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åŒ…å«ä¸€ä¸ªé”®å¯¹è±¡å’Œä¸€ä¸ªå€¼å¯¹è±¡ã€‚
Mapæ¥å£è§„å®šäº†è¿™ç±»é›†åˆçš„åŸºæœ¬é›å½¢ï¼Œä¹Ÿå°±æ˜¯çº¦å®šäº†å‘é›†åˆæ”¾å…¥å…ƒç´ ï¼Œä»é›†åˆå–å…ƒç´ ï¼Œè·å–é›†åˆå¤§å°ç­‰å¾…ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä»¥åŠçº¦å®šäº†key-valueç»“æ„çš„
å…ƒç´ çš„æ¥å£Entry<K,V>ï¼Œå®ƒçš„å®ç°ç±»å¿…é¡»å®ç°æ­¤æ¥å£ã€‚
Mapæ¥å£çš„å®ç°ä¸»è¦æœ‰ä¸¤ç±»ï¼šHashMapç±»å’ŒTreeMapç±»ã€‚å…¶ä¸­ï¼ŒHashMapç±»æŒ‰å“ˆå¸Œç®—æ³•æ¥å­˜å–é”®å¯¹è±¡ï¼Œè€ŒTreeMapç±»å¯ä»¥å¯¹é”®å¯¹è±¡è¿›è¡Œæ’åºã€‚

***åŸºäºJDK1.8***
## äºŒã€HashMapç±»

### 2.1 åº•å±‚æ•°æ®ç»“æ„ï¼š

HashMapçš„åº•å±‚æ•°æ®åœ¨JDK 1.7ç‰ˆæœ¬æ˜¯Tableæ•°ç»„ + Entryé“¾è¡¨ï¼Œåœ¨JDK1.8ç‰ˆæœ¬æ˜¯ Tableæ•°ç»„ + Entryé“¾è¡¨/çº¢é»‘æ ‘ï¼›(ä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¢é»‘æ ‘ï¼Ÿ)

HashMapç»“æ„å›¾ï¼š
![HashMapç»“æ„å›¾](https://raw.githubusercontent.com/qinguan1/qinguan1.github.io/main/docs/assets/img/qinguan/HashMapç»“æ„å›¾.png)

>**å°è´´å£«ï¼š**
>- Javaä¸­ï¼ŒTreeMapã€TreeSetéƒ½ä½¿ç”¨çº¢é»‘æ ‘ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„
>- JDK1.8å¼€å§‹ï¼ŒHashMapä¹Ÿå¼•å…¥äº†çº¢é»‘æ ‘ï¼šå½“å†²çªçš„é“¾è¡¨é•¿åº¦è¶…è¿‡8æ—¶ï¼Œè‡ªåŠ¨è½¬ä¸ºçº¢é»‘æ ‘
>- Linuxåº•å±‚çš„CFSè¿›ç¨‹è°ƒåº¦ç®—æ³•ä¸­ï¼Œvruntimeä½¿ç”¨çº¢é»‘æ ‘è¿›è¡Œå­˜å‚¨ã€‚
>- å¤šè·¯å¤ç”¨æŠ€æœ¯çš„Epollï¼Œå…¶æ ¸å¿ƒç»“æ„æ˜¯çº¢é»‘æ ‘ + åŒå‘é“¾è¡¨ã€‚

### 2.2 åˆå§‹åŒ–

ä»€ä¹ˆæ˜¯è´Ÿè½½å› å­ï¼ˆ loadFactor ï¼‰ï¼Ÿ
æˆ‘ä»¬çŸ¥é“ï¼Œç¬¬ä¸€æ¬¡åˆ›å»º HashMap çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šå…¶å®¹é‡ï¼ˆ1.7é»˜è®¤å®¹é‡ä¸º16ï¼Œ1.8é»˜è®¤å®¹é‡ä¸º0ï¼‰ï¼Œé‚£éšç€æˆ‘ä»¬ä¸æ–­çš„å‘ HashMap 
ä¸­ put å…ƒç´ çš„æ—¶å€™ï¼Œå°±æœ‰å¯èƒ½ä¼šè¶…è¿‡å…¶å®¹é‡ï¼Œé‚£ä¹ˆå°±éœ€è¦æœ‰ä¸€ä¸ªæ‰©å®¹æœºåˆ¶ã€‚å¦‚æœå…ƒç´ ä¸ªæ•°ï¼ˆsizeï¼‰è¶…è¿‡ä¸´ç•Œå€¼ï¼ˆthresholdï¼‰çš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œè‡ªåŠ¨æ‰©å®¹ï¼ˆresizeï¼‰ï¼Œå¹¶ä¸”ï¼Œåœ¨æ‰©å®¹ä¹‹åï¼Œè¿˜éœ€è¦å¯¹ HashMap ä¸­åŸæœ‰å…ƒç´ è¿›è¡Œ rehashï¼Œå³å°†åŸæ¥æ¡¶ä¸­çš„å…ƒç´ é‡æ–°åˆ†é…åˆ°æ–°çš„æ¡¶ä¸­ã€‚

**æ‰©å®¹é˜ˆå€¼ï¼ˆ threshold ï¼‰ = è´Ÿè½½å› å­ï¼ˆ loadFactor ï¼‰ * å®¹é‡ï¼ˆ capacity ï¼‰**

HashMapé»˜è®¤çš„è´Ÿè½½å› å­æ˜¯0.75

### 2.2 æ”¾å…¥å…ƒç´ 

hashMapçš„putæºç ï¼š

```java
    final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
        // pï¼šè¡¨ç¤ºå½“å‰æ•£åˆ—è¡¨çš„å…ƒç´ ï¼Œnï¼šæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ï¼Œiï¼šå¯»å€çš„ç»“æœ
        Node<K,V>[] tab; Node<K,V> p; int n, i;
        // å¦‚æœtableè¡¨æœªåˆå§‹åŒ–ï¼Œæˆ–è€…æ•°ç»„é•¿åº¦ä¸º0ï¼Œå°±ä¼šè¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå¹¶è¿”å›æ‰©å®¹åçš„æ•°ç»„é•¿åº¦
        // resize()æ‰©å®¹æ–¹æ³•ä¼šå¼€ä¸“é¢˜è®²è§£
        if ((tab = table) == null || (n = tab.length) == 0)
            n = (tab = resize()).length;
        // é€šè¿‡å–æ¨¡è¿ç®—ï¼ˆå‰æ–‡è¯¦ç»†å†™é“ï¼‰ï¼Œæ¥è·å¾—å¯»å€ç»“æœ
        // ä¹Ÿå°±æ˜¯ä¼ å…¥çš„key-valueé”®å€¼å¯¹åœ¨æ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®    
        if ((p = tab[i = (n - 1) & hash]) == null)
        	// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ­¤å¤„è¿˜æ²¡æœ‰å­˜å‚¨å…ƒç´ ï¼Œå°†key-valueåŒ…è£…æˆNodeè®¾ç½®åœ¨iå¤„
            tab[i] = newNode(hash, key, value, null);
        // elseè¯´æ˜å¯»å€ç»“æœiå·²ç»å­˜å‚¨çš„æœ‰å…ƒç´ äº†ï¼Œå“ˆå¸Œå†²çªäº†
        else {
        	// ä¸¤ä¸ªä¸´æ—¶å˜é‡ï¼Œnodeå’Œkey
            Node<K,V> e; K k;
            // è¡¨ç¤ºä½ è¦æ’å…¥çš„keyå’ŒåŸä½ç½®çš„keyå®Œå…¨ç›¸åŒï¼Œè¿™é‡Œå°†pèµ‹å€¼ç»™eï¼Œä¾¿äºåæ–‡çš„æ›¿æ¢æ“ä½œ
            if (p.hash == hash &&
                ((k = p.key) == key || (key != null && key.equals(k))))
                e = p;
            // æ­¤æ—¶è¯´æ˜på·²ç»æ ‘åŒ–ï¼Œè°ƒç”¨çº¢é»‘æ ‘çš„æ–¹æ³•æ·»åŠ åˆ°æŒ‡å®šä½ç½®
            else if (p instanceof TreeNode)
                e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
                
            else {// èµ°åˆ°è¿™é‡Œè¯´æ˜ï¼Œhashå¯»å€å†²çªäº†ï¼Œå¹¶ä¸”å’Œå¯»å€ç»“æœiå¤„çš„keyä¸åŒï¼Œä¹Ÿä¸æ˜¯æ ‘ï¼Œè¯´æ˜æ­¤æ—¶è¦åœ¨é“¾è¡¨ä¸Šæ“ä½œäº†
            	// æ‰¾åˆ°é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼Œæ’å…¥æ–°èŠ‚ç‚¹
                for (int binCount = 0; ; ++binCount) {
                    if ((e = p.next) == null) {
                        p.next = newNode(hash, key, value, null);
                        // è¯´æ˜æ­¤æ—¶é“¾è¡¨é•¿åº¦è¶…è¿‡äº†æ ‘åŒ–é˜ˆå€¼ï¼Œè¿›è¡Œæ ‘åŒ–
                        if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                            treeifyBin(tab, hash);
                        break;
                    }
                    // æ­¤æ—¶åœ¨é“¾è¡¨æ‰¾å°¾èŠ‚ç‚¹æ—¶ï¼Œå‘ç°äº†å’Œæ–°æ’å…¥èŠ‚ç‚¹å®Œå…¨ä¸€è‡´çš„keyï¼Œæ‰€ä»¥è®°å½•ï¼Œè·³å‡ºï¼Œåæ–‡æ›¿æ¢
                    if (e.hash == hash &&
                        ((k = e.key) == key || (key != null && key.equals(k))))
                        break;
                    p = e;
                }
            }
            // æ›¿æ¢æ“ä½œï¼Œå¦‚æœe!=nullï¼Œè¯´æ˜eè®°å½•äº†å†²çªçš„èŠ‚ç‚¹
            if (e != null) { // existing mapping for key
            	//è®°å½•è€å€¼ï¼Œç”¨äºè¿”å›
                V oldValue = e.value;
                // å¼€å¤´ä¼ å…¥çš„å‚æ•°flaseï¼Œè¯´æ˜å†²çªæ—¶ä¼šè¿›è¡Œæ›¿æ¢æ“ä½œ
                if (!onlyIfAbsent || oldValue == null)
                    e.value = value;
                // å…·ä½“å®ç°åœ¨LinkedHashMapï¼Œæ­¤å¤„ä¸åœ¨è¯¦è§£
                afterNodeAccess(e);
                return oldValue;
            }
        }
        //å¯¹æ•£åˆ—è¡¨æ“ä½œè¿›è¡Œè®°å½•ï¼Œç”¨äºfast-failæœºåˆ¶
        ++modCount;
        //å¦‚æœæ’å…¥åå…ƒç´ è¶…è¿‡äº†æ‰©å®¹é˜ˆå€¼ï¼Œå°±ä¼šè¿›è¡Œæ‰©å®¹æ“ä½œ
        if (++size > threshold)
            resize();
        afterNodeInsertion(evict);
        return null;
    }

    /**
    * Replaces all linked nodes in bin at index for given hash unless
    * table is too small, in which case resizes instead.
    * æ›¿æ¢ç»™å®šå“ˆå¸Œè¡¨çš„ç´¢å¼•å¤„çš„æ‰€æœ‰é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œå“ˆå¸Œè¡¨å¤ªå°çš„æƒ…å†µä¸‹ï¼Œä¼šè¿›è¡Œæ‰©å®¹ã€‚
    */
    final void treeifyBin(Node<K, V>[] tab, int hash) {
        // å®šä¹‰n:èŠ‚ç‚¹æ•°ç»„é•¿åº¦ã€index:æ•£åˆ—è¡¨æ•°ç»„å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€e:ç”¨äºå¾ªç¯çš„è¿­ä»£å˜é‡,ä»£è¡¨å½“å‰èŠ‚ç‚¹
        int n, index;
        Node<K, V> e;
        // è‹¥æ•£åˆ—è¡¨æ•°ç»„å°šæœªåˆå§‹åŒ–æˆ–è€…æ•°ç»„é•¿åº¦å°äº64,åˆ™ç›´æ¥æ‰©å®¹è€Œä¸è¿›è¡Œæ ‘å½¢åŒ–
        if (tab == null || (n = tab.length) < MIN_TREEIFY_CAPACITY)
            resize();
        else if ((e = tab[index = (n - 1) & hash]) != null) {// è·å–æŒ‡å®šæ•°ç»„ä¸‹æ ‡çš„å¤´ç»“ç‚¹e
            // å®šä¹‰headèŠ‚ç‚¹hdã€å°¾èŠ‚ç‚¹tl
            TreeNode<K, V> hd = null, tl = null;
            // å¾ªç¯,è¯¥å¾ªç¯ä¸»è¦æ˜¯å°†åŸå•å‘é“¾è¡¨è½¬åŒ–ä¸ºåŒå‘é“¾è¡¨
            do {
                // ä»¥eçš„hashã€keyã€value,ä»¥åŠä»¥nullä¸ºåç»§å…ƒåˆ›å»ºæ ‘å½¢èŠ‚ç‚¹p
                TreeNode<K, V> p = replacementTreeNode(e, null);
                // è‹¥å°¾èŠ‚ç‚¹ä¸ºnullè¡¨æ˜é¦–æ¬¡å¾ªç¯,æ­¤æ—¶eä¸ºå¤´ç»“ç‚¹ã€pä¸ºæ ¹èŠ‚ç‚¹,å› æ­¤å°†pèµ‹å€¼ç»™è¡¨ç¤ºå¤´ç»“ç‚¹çš„hd
                if (tl == null)
                    hd = p;
                // è´Ÿè´£æ ¹èŠ‚ç‚¹å·²ç»äº§ç”Ÿè¿‡äº†æ­¤æ—¶tlå°¾èŠ‚ç‚¹æŒ‡å‘ä¸Šæ¬¡å¾ªç¯åˆ›å»ºçš„æ ‘å½¢èŠ‚ç‚¹
                else {
                    // æ­¤æ—¶pä¸ºä¸Šæ¬¡å¾ªç¯çš„çš„åç»§å…ƒåœ¨æœ¬æ¬¡å¾ªç¯ä¸ºå½“å‰èŠ‚ç‚¹,äº§ç”Ÿå½“å‰èŠ‚ç‚¹ä¸å‰é©±å…ƒçš„prevé“¾
                    p.prev = tl;
                    // äº§ç”Ÿå‰é©±å…ƒä¸å½“å‰èŠ‚ç‚¹çš„nexté“¾
                    tl.next = p;
                }
                // å°†tlæŒ‡å‘å½“å‰èŠ‚ç‚¹
                tl = p;
            } while ((e = e.next) != null);// eæŒ‡å‘eçš„åç»§å…ƒç´ 
            // è‹¥æŒ‡å®šçš„ä½ç½®å¤´ç»“ç‚¹ä¸ä¸ºç©ºåˆ™è¿›è¡Œæ ‘å½¢åŒ–
            if ((tab[index] = hd) != null)
                // æ ¹æ®é“¾è¡¨åˆ›å»ºçº¢é»‘æ ‘ç»“æ„
                hd.treeify(tab);
        }
    }

```

hashMapçš„putæ–¹æ³•æµç¨‹å›¾ï¼š
![HashMapçš„putæ–¹æ³•æµç¨‹å›¾](https://raw.githubusercontent.com/qinguan1/qinguan1.github.io/main/docs/assets/img/qinguan/HashMapçš„putæ–¹æ³•æµç¨‹å›¾.png)

è‹¥hashæ¡¶ä¸­é“¾è¡¨å…ƒç´ è¶…è¿‡8ï¼Œæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ä¼šè‡ªåŠ¨è½¬åŒ–æˆçº¢é»‘æ ‘
ä¹‹æ‰€ä»¥æ˜¯8ï¼Œæ˜¯å› ä¸ºJavaçš„æºç è´¡çŒ®è€…åœ¨è¿›è¡Œå¤§é‡å®éªŒå‘ç°ï¼Œhashç¢°æ’å‘ç”Ÿ8æ¬¡çš„æ¦‚ç‡å·²ç»é™ä½åˆ°äº†0.00000006ï¼Œå‡ ä¹ä¸ºä¸å¯èƒ½äº‹ä»¶ï¼Œ
å¦‚æœçœŸçš„ç¢°æ’å‘ç”Ÿäº†8æ¬¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™è¯´æ˜ç”±äºå…ƒç´ æœ¬èº«å’Œhashå‡½æ•°çš„åŸå› ï¼Œæ­¤æ¬¡æ“ä½œçš„hashç¢°æ’çš„å¯èƒ½æ€§éå¸¸å¤§äº†ï¼Œ
ååºå¯èƒ½è¿˜ä¼šç»§ç»­å‘ç”Ÿhashç¢°æ’ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±åº”è¯¥å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘äº†ï¼Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆé“¾è¡¨è½¬çº¢é»‘æ ‘çš„é˜ˆå€¼æ˜¯8ã€‚ 
æœ€åï¼Œçº¢é»‘æ ‘è½¬é“¾è¡¨çš„é˜ˆå€¼ä¸º6ï¼Œä¸»è¦æ˜¯å› ä¸ºï¼Œå¦‚æœä¹Ÿå°†è¯¥é˜ˆå€¼è®¾ç½®äº8ï¼Œé‚£ä¹ˆå½“hashç¢°æ’åœ¨8æ—¶ï¼Œä¼šåç”Ÿé“¾è¡¨å’Œçº¢é»‘æ ‘çš„ä¸åœç›¸äº’æ¿€è¡è½¬æ¢ï¼Œç™½ç™½æµªè´¹èµ„æºã€‚

### 2.2 æ‰©å®¹

```java 

final Node<K,V>[] resize()

```
ä¸€èˆ¬çš„æ‰©å®¹åœºæ™¯ï¼š
1. å°†ä¸€ä¸ªMapé›†åˆBæ”¾å…¥å½“å‰çš„é›†åˆAä¸­ï¼Œå¦‚æœBé›†åˆä¸ä¸ºç©ºï¼Œä¸”Bé›†åˆçš„å®¹é‡å¤§äºæ‰©å®¹é˜ˆå€¼ï¼ˆthresholdï¼‰ï¼Œä¼šå‘ç”Ÿæ‰©å®¹
2. å‘é›†åˆä¸­æ·»åŠ å…ƒç´ æ—¶ï¼Œå¦‚æœé›†åˆçš„å®¹é‡åœ¨æ·»åŠ åå¤§äºæ‰©å®¹é˜ˆå€¼ï¼ˆthresholdï¼‰ï¼Œä¼šå‘ç”Ÿæ‰©å®¹
3. é“¾è¡¨æ ‘åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ•£åˆ—è¡¨æ•°ç»„çš„é•¿åº¦ä¸è¶³64ï¼Œåˆ™ç”¨æ‰©å®¹ä»£æ›¿äº†æ ‘åŒ–

æ¯æ¬¡æ‰©å®¹çš„å®¹é‡éƒ½æ˜¯ä¹‹å‰å®¹é‡çš„ 2 å€ï¼ŒHashMap çš„å®¹é‡æ˜¯æœ‰ä¸Šé™çš„ï¼Œå¿…é¡»å°äº 1<<30ï¼Œå³ 1073741824ã€‚å¦‚æœå®¹é‡è¶…å‡ºäº†è¿™ä¸ªèŒƒå›´ï¼Œåˆ™é˜ˆå€¼ä¼šè¢«è®¾ç½®ä¸º Integer.MAX_VALUEã€‚

æ‰©å®¹æœºåˆ¶ï¼š

- ç©ºå‚æ•°çš„æ„é€ å‡½æ•°ï¼šå®ä¾‹åŒ–çš„ HashMap é»˜è®¤å†…éƒ¨æ•°ç»„æ˜¯ nullï¼Œå³æ²¡æœ‰å®ä¾‹åŒ–ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨ put æ–¹æ³•æ—¶ï¼Œåˆ™ä¼šå¼€å§‹ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ‰©å®¹ï¼Œé•¿åº¦ä¸º 16ã€‚ 
- æœ‰å‚æ„é€ å‡½æ•°ï¼šç”¨äºæŒ‡å®šå®¹é‡ã€‚ä¼šæ ¹æ®æŒ‡å®šçš„æ­£æ•´æ•°æ‰¾åˆ°ä¸å°äºæŒ‡å®šå®¹é‡çš„ 2 çš„å¹‚æ•°ï¼Œ å°†è¿™ä¸ªæ•°è®¾ç½®èµ‹å€¼ç»™æ‰©å®¹é˜ˆå€¼ï¼ˆthresholdï¼‰ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨ put æ–¹æ³•æ—¶ï¼Œä¼šå°†é˜ˆå€¼èµ‹å€¼ç»™å®¹é‡ï¼Œ ç„¶åè®©é˜ˆå€¼ = å®¹é‡ x è´Ÿè½½å› å­ã€‚ 
- å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œåˆ™å®¹é‡å˜ä¸ºåŸæ¥çš„ 2 å€ï¼Œé˜ˆå€¼ä¹Ÿå˜ä¸ºåŸæ¥çš„ 2 å€ã€‚ï¼ˆå®¹é‡å’Œé˜ˆå€¼ éƒ½å˜ä¸ºåŸæ¥çš„ 2 å€æ—¶ï¼Œè´Ÿè½½å› å­è¿˜æ˜¯ä¸å˜ï¼‰ã€‚ 
- æ­¤å¤–è¿˜æœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ï¼š
    - é¦–æ¬¡ put æ—¶ï¼Œå…ˆä¼šè§¦å‘æ‰©å®¹ï¼ˆç®—æ˜¯åˆå§‹åŒ–ï¼‰ï¼Œç„¶åå­˜å…¥æ•°æ®ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼› 
    - ä¸æ˜¯é¦–æ¬¡ putï¼Œåˆ™ä¸å†åˆå§‹åŒ–ï¼Œç›´æ¥å­˜å…¥æ•°æ®ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼›

>**å¤šçº¿ç¨‹ä¸‹çš„é—®é¢˜**
>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨JDK1.7çš„æ—¶å€™ï¼ŒHashMapåœ¨å¤šçº¿ç¨‹ä½¿ç”¨çš„åœºæ™¯ä¸‹ï¼Œæ‰©å®¹æ—¶ä¼šå‘ç”Ÿæ­»é”é—®é¢˜ï¼Œåœ¨JDK1.8çš„æ—¶å€™ä¿®å¤äº†è¯¥é—®é¢˜ï¼Œ
ä½†æ˜¯ï¼äº‹æƒ…å¹¶æ²¡æœ‰ç»“æŸï¼Œå¦‚æœä½ åœ¨JDK1.8ç»§ç»­åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ä½¿ç”¨å®ƒï¼Œè¿˜æ˜¯æœ‰æ­»é”é—®é¢˜ï¼š

ç¤ºä¾‹ä»£ç ï¼š
```java

public class TestHashMapDeadLock {

    public static void main(String[] args) {
        HashMapThread hmt0 = new HashMapThread();
        HashMapThread hmt1 = new HashMapThread();
        HashMapThread hmt2 = new HashMapThread();
        HashMapThread hmt3 = new HashMapThread();
        HashMapThread hmt4 = new HashMapThread();
        HashMapThread hmt5 = new HashMapThread();
        HashMapThread hmt6 = new HashMapThread();
        HashMapThread hmt7 = new HashMapThread();
        HashMapThread hmt8 = new HashMapThread();
        HashMapThread hmt9 = new HashMapThread();
        HashMapThread hmt10 = new HashMapThread();
        HashMapThread hmt11 = new HashMapThread();
        HashMapThread hmt12 = new HashMapThread();
        hmt0.start();
        hmt1.start();
        hmt2.start();
        hmt3.start();
        hmt4.start();
        hmt5.start();
        hmt6.start();
        hmt7.start();
        hmt8.start();
        hmt9.start();
        hmt10.start();
        hmt11.start();
        hmt12.start();
    }
}

class HashMapThread extends Thread {
    private static AtomicInteger ai = new AtomicInteger(0);
    private static Map<Integer, Integer> map = new HashMap<>(1);

    @Override
    public void run() {
        while (ai.get() < 100000) {
            map.put(ai.get(), ai.get());
            ai.incrementAndGet();
        }
        System.out.println(Thread.currentThread().getName() + "æ‰§è¡Œç»“æŸå®Œ");
    }
}

```
æ€»ç»“ä¸€ä¸‹ï¼š
**å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œä¸è¦ä½¿ç”¨HashMapï¼è¯·ä½¿ç”¨çº¿ç¨‹å®‰å…¨ç±»ï¼šConcurrentHashMapï¼**

>**å°è´´å£«ï¼š**
**åœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œä¼šå¯¹é•¿åº¦å°äº6çš„çº¢é»‘æ ‘è¿›è¡Œé“¾è¡¨çš„è½¬æ¢ã€‚**

### 2.3 æ•£åˆ—è¡¨çš„å®ç°
#### 2.3.1 æ•£åˆ—è¡¨

æ•£åˆ—è¡¨çš„è‹±æ–‡å«â€œHash Tableâ€ï¼Œæˆ‘ä»¬å¹³æ—¶ä¹Ÿå«å®ƒâ€œå“ˆå¸Œè¡¨â€æˆ–è€…â€œHashè¡¨"
æ•£åˆ—è¡¨ç”¨çš„æ˜¯æ•°ç»„æ”¯æŒæŒ‰ç…§ä¸‹æ ‡éšæœºè®¿é—®æ•°æ®çš„ç‰¹æ€§ï¼Œæ‰€ä»¥æ•£åˆ—è¡¨å…¶å®å°±æ˜¯æ•°ç»„çš„ä¸€ç§æ‰©å±•ï¼Œç”±æ•°ç»„æ¼”åŒ–è€Œæ¥ã€‚
å¯ä»¥è¯´ï¼Œå¦‚æœæ²¡æœ‰æ•°ç»„ï¼Œå°±æ²¡æœ‰æ•£åˆ—è¡¨ã€‚
æœ€å¥½æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ‰©å®¹ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼Œæ¯æ¬¡è·å–å…ƒç´ ä¸éœ€è¦éå†é“¾è¡¨
æ¯”è¾ƒåçš„æƒ…å†µæ˜¯å¤§é‡å…ƒç´ èšé›†åœ¨å°‘é‡çš„é“¾è¡¨ä¸­ï¼Œæ¯æ¬¡çš„æŸ¥è¯¢éƒ½éœ€è¦éå†æ•´ä¸ªé“¾è¡¨ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)

#### 2.3.2 æ‰°åŠ¨å‡½æ•°

**ä¸ºä»€ä¹ˆè¦ç”¨æ‰°åŠ¨å‡½æ•°ï¼Ÿ**
- æ‰°åŠ¨å‡½æ•°æ˜¯ä¸ºäº†è§£å†³é›†åˆkeyçš„hashç¢°æ’é—®é¢˜,å°½å¯èƒ½åœ°è®©å…ƒç´ å‡åŒ€åˆ†å¸ƒåœ¨æ•£åˆ—è¡¨å½“ä¸­

HashMap æºç ï¼š
```java

    static final int hash(Object key) {
        int h;
        return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
    }
```

## ä¸‰ã€Hashtableç±»

åœ¨Javaå‘å±•çš„æ—©æœŸå°±åœ¨æ”¯æŒå¤šçº¿ç¨‹äº†ï¼Œæ‰€ä»¥ä¹Ÿæä¾›äº†ä¸€äº›çº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼Œæ¯”å¦‚åœ¨æœ€æ—©JDK1.2æä¾›çš„é›†åˆå®¹å™¨ç±»æ¯”å¦‚Vectorã€Hashtableï¼Œä»–ä»¬çš„å®ç°æœºåˆ¶éƒ½å·®ä¸å¤šï¼Œéƒ½æ˜¯åœ¨æ–¹æ³•å±‚é¢ä¸ŠåŠ synchronizedå…³é”®å­—æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚è¿™ç§çº¿ç¨‹å®‰å…¨æ˜¯ä»¥é™ä½æ€§èƒ½ä¸ºä»£ä»·çš„ï¼Œæ—¶è‡³ä»Šæ—¥ Hashtable å®ƒçš„æŠ½è±¡çˆ¶ç±» Dictionary å·²è¢«æç¤ºä¸ºå¼ƒç”¨

```java
/**
 * <strong>NOTE: This class is obsolete.  New implementations should
 * implement the Map interface, rather than extending this class.</strong>
 */
 public abstract
class Dictionary<K,V> {
    ...
}
```

æ‰€ä»¥ ***Hashtable ä¸€èˆ¬æ˜¯ä¸è¢«æ¨èä½¿ç”¨çš„***

## å››ã€ConcurrentHashMapç±»
### 4.1ã€æ¦‚è¿°

ä»JDK1.5å¼€å§‹æä¾›äº†å¤šç§å¹¶å‘å®¹å™¨ç”¨æ¥æ”¹è¿›åŒæ­¥å®¹å™¨çš„æ€§èƒ½ï¼Œæ¯”å¦‚ç”¨äºæ›¿ä»£ Hashtable çš„åŒæ­¥å®¹å™¨çš„ ConcurrentHashMapã€‚
ConcurrentHashMap ä¸¥æ ¼æ¥è¯´æ˜¯çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬çš„ HashMapï¼Œè¢«ç”¨æ¥æ›¿ä»£ Hashtableï¼Œå®ƒçš„å‡ºç°è§£å†³äº† Hashtable çš„ä¸€äº›å¼Šç«¯ï¼Œæ¯”å¦‚æ€§èƒ½ä½ä¸‹ï¼Œè¿™æ–¹é¢ä¸»è¦ä½“ç°åœ¨ Hashtable çš„çº¿ç¨‹å®‰å…¨æ˜¯åŸºäº synchronized å…³é”®å­—ï¼Œæ—©æœŸçš„ synchronized é”å±äºé‡é‡çº§é”ï¼Œæ‰€ä»¥å¯¹äº Hashtable è€Œè¨€ï¼Œæ¯ä¸€æ¬¡å¯¹é›†åˆçš„æ“ä½œéƒ½æ˜¯ä¸²è¡Œçš„ï¼Œå®ƒæ˜¯ä¼šé”ä½æ•´ä¸ª hash è¡¨ã€‚
JDK1.7ä¸­çš„ ConcurrentHashMap é‡‡ç”¨ä¸€ç§æ›´åŠ ç»†ç²’åº¦çš„ **â€œåˆ†æ®µé”â€** åŠ é”æœºåˆ¶ï¼Œå°†æ•´å¼ è¡¨åˆ†æˆäº†å¤šä¸ªæ•°ç»„ï¼ˆSegmentæ®µï¼‰ï¼Œç„¶åæ¯ä¸ªæ•°ç»„å…ƒç´ åˆæ˜¯ä¸€ä¸ªHashMapï¼ˆhashè¡¨ï¼‰ï¼ŒåŠ é”çº§åˆ«åªåœ¨ Segment æ®µä¸Šï¼ŒSegmentç»§æ‰¿äº†ä¹è§‚é”ReentrantLockï¼Œè¿™å°±æ„å‘³ç€ä¸åŒçš„ Segment æ®µæ˜¯ä¸ä¼šé”å†²çªçš„ï¼Œå¤§å¤§æå‡äº†å¹¶å‘æ€§èƒ½ã€‚
å½“ç„¶äº†è¿™ç§æ–¹å¼ä¹Ÿæœ‰é—®é¢˜ï¼Œç¼ºç‚¹åœ¨äºåˆ†æˆå¾ˆå¤šæ®µæ—¶ä¼šæ¯”è¾ƒæµªè´¹å†…å­˜ç©ºé—´(ä¸è¿ç»­ï¼Œç¢ç‰‡åŒ–); æ“ä½œ Map æ—¶ç«äº‰åŒä¸€ä¸ªåˆ†æ®µé”çš„æ¦‚ç‡éå¸¸å°æ—¶ï¼Œåˆ†æ®µé”åè€Œä¼šé€ æˆæ›´æ–°ç­‰æ“ä½œçš„é•¿æ—¶é—´ç­‰å¾…; å½“æŸä¸ªæ®µå¾ˆå¤§æ—¶ï¼Œåˆ†æ®µé”çš„æ€§èƒ½ä¼šä¸‹é™ã€‚
JDK1.8çš„å®ç°å·²ç»æ‘’å¼ƒäº† Segment çš„æ¦‚å¿µï¼Œæˆ–è€…è¯´å¼±åŒ–äº† Segmentï¼Œè€Œæ˜¯ç›´æ¥ç”¨Nodeæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨Synchronized å’ŒCASæ¥æ“ä½œï¼Œè¿™é‡Œä¹Ÿæ¶‰åŠåˆ°å…³äº Synchronized é”çš„ä¼˜åŒ–ï¼Œè¿™ä¸ªåœ¨å¦ä¸€ä¸ªä¸“é¢˜ä¼šè¯¦ç»†è®²è§£ã€‚

### 4.2ã€ä¸HashMapçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
ConcurrentHashMapæ˜¯ HashMap çš„å‡çº§ç‰ˆï¼ŒHashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œè€ŒConcurrentHashMapæ˜¯çº¿ç¨‹å®‰å…¨ã€‚
è€Œå…¶ä»–åŠŸèƒ½å’Œå®ç°åŸç†å’Œ HashMap ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚

ä¿®æ”¹sizeCtlçš„æ–¹æ³•æœ‰äº”ä¸ªï¼š
1. initTable()
2. addCount()
3. tryPresize()
4. transfer()
5. helpTransfer()

>**å°è´´å£«ï¼šä¸ºä»€ä¹ˆä¸ç”¨ReentrantLockè€Œç”¨ synchronized ?** 
>- å‡å°‘å†…å­˜å¼€é”€ï¼šå¦‚æœä½¿ç”¨ReentrantLockåˆ™éœ€è¦èŠ‚ç‚¹ç»§æ‰¿AQSæ¥è·å¾—åŒæ­¥æ”¯æŒï¼Œå¢åŠ å†…å­˜å¼€é”€ï¼Œè€ŒJDK1.8ä¸­åªæœ‰å¤´èŠ‚ç‚¹éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚
>- Synchronized åˆ™æ˜¯JVMç›´æ¥æ”¯æŒçš„ï¼ŒJVMèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶ä½œå‡ºç›¸åº”çš„ä¼˜åŒ–æªæ–½ï¼šé”ç²—åŒ–ã€é”æ¶ˆé™¤ã€é”è‡ªæ—‹ç­‰ç­‰ã€‚

**ConcurrentHashMapä»JDK1.7åˆ°JDK1.8çš„åŒºåˆ«æ±‡æ€»ï¼š**
- JDK1.8ä¸­æ–°å¢äº†çº¢é»‘æ ‘ï¼Œæé«˜äº†æŸ¥è¯¢æ•ˆç‡
- JDK1.7ä¸­ä½¿ç”¨çš„æ˜¯å¤´æ’æ³•ï¼ŒJDK1.8ä¸­ä½¿ç”¨çš„æ˜¯å°¾æ’æ³•
- JDK1.7ä¸­ä½¿ç”¨äº†åˆ†æ®µé”ï¼Œè€ŒJDK1.8ä¸­æ²¡æœ‰ä½¿ç”¨åˆ†æ®µé”äº†
- JDK1.7ä¸­ä½¿ç”¨äº†ReentrantLockï¼ŒJDK1.8ä¸­æ²¡æœ‰ä½¿ç”¨ReentrantLockäº†ï¼Œè€Œä½¿ç”¨äº†Synchronized
- JDK1.7ä¸­çš„æ‰©å®¹æ˜¯æ¯ä¸ªSegmentå†…éƒ¨è¿›è¡Œæ‰©å®¹ï¼Œä¸ä¼šå½±å“å…¶ä»–Segmentï¼Œè€ŒJDK1.8ä¸­çš„æ‰©å®¹å’ŒHashMapçš„æ‰©å®¹ç±»ä¼¼ï¼Œåªä¸è¿‡æ”¯æŒäº†å¤šçº¿ç¨‹æ‰©å®¹ï¼Œå¹¶ä¸”ä¿è¯äº†çº¿ç¨‹å®‰å…¨

ConcurrentHashMap åœ¨ HashMap çš„åŸºç¡€ä¸Šåšäº†å¾ˆå¤šå¤šçº¿ç¨‹æ–¹é¢çš„æ”¹åŠ¨ï¼š
- æ–°å¢ sizeCtl æˆå‘˜å±æ€§ã€‚å®ƒæ˜¯ä¸€ä¸ªæ§åˆ¶æ ‡è¯†ç¬¦ï¼Œåœ¨ä¸åŒçš„åœ°æ–¹æœ‰ä¸åŒç”¨é€”ï¼Œè€Œä¸”å®ƒçš„å–å€¼ä¸åŒï¼Œä¹Ÿä»£è¡¨ä¸åŒçš„å«ä¹‰ï¼š
    - è´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹æ“ä½œ
    - -1ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–
    - -N è¡¨ç¤ºå–-Nå¯¹åº”çš„äºŒè¿›åˆ¶çš„ä½16ä½æ•°å€¼ä¸ºMï¼Œæ­¤æ—¶æœ‰M-1ä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹
    - æ­£æ•°æˆ–0ä»£è¡¨hashè¡¨è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºåˆå§‹åŒ–æˆ–ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å°ï¼Œè¿™ä¸€ç‚¹ç±»ä¼¼äºæ‰©å®¹é˜ˆå€¼çš„æ¦‚å¿µã€‚
    è¿˜åé¢å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å€¼å§‹ç»ˆæ˜¯å½“å‰ ConcurrentHashMap å®¹é‡çš„0.75å€ï¼Œè¿™ä¸loadfactoræ˜¯å¯¹åº”çš„ã€‚
- ä¿®æ”¹ **volatile** Node<K,V>[] table; å¢åŠ äº† **volatile** å…³é”®å­—ä¿®é¥°ï¼Œä¿è¯äº†å¯è§æ€§å’Œç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚
- æ–°å¢ **volatile** Node<K,V>[] nextTable; åœ¨æ‰©å®¹æ—¶æ–°ç”Ÿæˆçš„æ•°ç»„ï¼Œå…¶å¤§å°ä¸ºå½“å‰tableçš„2å€ï¼Œç”¨äºå­˜æ”¾tableè½¬ç§»è¿‡æ¥çš„å€¼ï¼›
- ä¿®æ”¹ ç”¨äºå­˜å‚¨æ•°æ®çš„é™æ€å†…éƒ¨ç±» Node; å€¼ val å’Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ next éƒ½å¢åŠ äº† **volatile** å…³é”®å­—
    -  **volatile** V val;
    -  **volatile** Node<K,V> next;

>**å°è´´å£«ï¼š**
>- **ConcurrentHashMapçš„ key æ˜¯ä¸å¯ä»¥ä¸ºnullçš„**



## äº”ã€TreeMapç±»




## é«˜é¢‘é¢è¯•é¢˜éƒ¨åˆ†
HashMap14é—®ï¼šhttps://mp.weixin.qq.com/s/ktddPNAK5eQexSoFlr1vLw




















































