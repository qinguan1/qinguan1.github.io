# 一文讲透JVM垃圾回收

作者：qinguan
<br/>博客：[https://bugstack.cn](https://bugstack.cn)

> 故不积跬步，无以至千里；不积小流，无以成江海！🌻


既然要进行垃圾回收，那么第一步就要识别垃圾，第二步就是清理垃圾。

## 如何识别垃圾对象
### 引用计数法
引用计数法是一种内存管理技术，它的基本思想是跟踪每个对象被引用的次数，并在引用计数为零时自动释放对象所占用的内存空间。
无法解决循环引用问题
![引用计数法](https://raw.githubusercontent.com/qinguan1/qinguan1.github.io/main/docs/assets/img/qinguan/引用计数法.png)

### 可达性分析算法

可达性分析算法是一种垃圾回收算法，用于判断一个对象是否可达（即是否还有引用指向它），从而确定是否可以将该对象回收。
可达性分析算法的基本思想是从一组根对象（通常称为GC root）开始，递归遍历所有可能被引用的对象，将所有遍历到的对象标记为“已访问”，最终未被标记的对象即为垃圾对象，可以被回收。这种算法也是目前主流垃圾回收器所使用的算法。

![可达性分析算法](https://raw.githubusercontent.com/qinguan1/qinguan1.github.io/main/docs/assets/img/qinguan/可达性分析算法.png)

## 分代收集理论
分代收集理论是一种垃圾回收算法的理论基础，它将堆内存分为不同的年代，每个年代采用不同的垃圾回收策略。其中，新生代采用标记-复制算法，老年代采用标记-清除算法或标记-整理算法。
分代收集理论是一种整体的垃圾回收策略，具体的回收算法又分为好几种。

## 有哪些垃圾回收算法

### 标记-清除
标记-清除算法是一种垃圾回收算法，也是一种基于可达性分析的垃圾回收算法。
它的基本思想是在垃圾回收过程中，先标记出所有被引用的对象，然后清除所有未被标记的对象，从而释放它们占用的内存空间。
这个算法的主要缺点是它需要在垃圾回收过程中暂停程序的执行，因为在标记和清除的过程中，需要遍历整个堆内存，这会导致程序的执行速度变慢。另外，标记-清除算法还会产生内存碎片，这会影响程序的性能和内存利用率。
它的基本步骤有两个：
1. 标记阶段：标记可达对象
2. 清除阶段：清理未标记对象

![gc-标记清除](https://raw.githubusercontent.com/qinguan1/qinguan1.github.io/main/docs/assets/img/qinguan/gc-标记清除.png)

特点：`位置不连续，容易产生碎片`
### 标记-整理
标记整理算法是一种垃圾回收算法，主要用于`老年代`的垃圾回收。
它的基本思路是先标记出所有存活的对象，然后将这些对象向一端移动，然后清除掉另一端的所有垃圾对象。这样可以使得内存空间更加连续，从而提高内存的利用率。
标记整理算法主要适用于存活对象比较多、垃圾对象比较少的场景，因为移动对象需要较大的复制代价，如果存活对象太少，移动的代价会超过清除的代价，导致效率降低。
它的基本步骤有两个：
1. 标记阶段：它的第一个阶段与<kbd>标记清除算法</kbd>是一模一样的。
2. 整理阶段：移动所有`存活的对象`，且按照内存地址次序依次排列，然后将末端内存地址以后的内存全部回收。
![gc-标记整理](https://raw.githubusercontent.com/qinguan1/qinguan1.github.io/main/docs/assets/img/qinguan/gc-标记整理.png)

特点：`位置连续，没有碎片，效率偏低`
### 复制
标记复制算法是一种垃圾回收算法，主要用于`新生代`的垃圾回收。
它的基本思路是将新生代内存空间分为两个相等的区域，每次只使用其中一个区域，当这个区域满了之后，将其中存活的对象复制到另一个区域中，然后清空原来的区域。
这样可以保证内存空间的连续性，同时也减少了垃圾回收的复杂度。
标记复制算法主要适用于存活对象比较少、垃圾对象比较多的场景，因为复制的代价比较小，但是如果存活对象太多，复制的代价会变得很大，导致**效率降低**。
![gc-复制](https://raw.githubusercontent.com/qinguan1/qinguan1.github.io/main/docs/assets/img/qinguan/gc-复制.png)

特点：`位置连续，没有碎片，空间浪费严重`

## JVM堆模型  

![JVM堆模型](https://raw.githubusercontent.com/qinguan1/qinguan1.github.io/main/docs/assets/img/qinguan/JVM堆模型.png)

观察上面的堆模型我们


## 有哪些垃圾收集器

如果说收集算法是内存回收的方法论，那么垃圾收集器就是内存回收的具体实现。

